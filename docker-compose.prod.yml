services:
  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: bekleidung-backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-3077}:3077"
    environment:
      - NODE_ENV=production
      - PORT=3077
      - HOST=0.0.0.0
      - APP_HOST=${APP_HOST}
      - FRONTEND_PORT=${FRONTEND_PORT:-3078}
      - DATABASE_URL=file:/app/data/bekleidung.db
      - AZURE_TENANT_ID=${AZURE_TENANT_ID}
      - AZURE_CLIENT_ID=${AZURE_CLIENT_ID}
      - AZURE_CLIENT_SECRET=${AZURE_CLIENT_SECRET}
      - AZURE_REDIRECT_URI=${AZURE_REDIRECT_URI}
      - JWT_SECRET=${JWT_SECRET}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - SMTP_FROM=${SMTP_FROM}
      - BACKUP_DIR=/app/backups
      - BACKUP_RETENTION_DAYS=${BACKUP_RETENTION_DAYS:-30}
      - UPLOAD_DIR=/app/uploads
      - LOG_DIR=/app/logs
      - LOG_LEVEL=${LOG_LEVEL:-info}
    volumes:
      - ./data:/app/data
      - ./uploads:/app/uploads
      - ./backups:/app/backups
      - ./logs:/app/logs
      - ./ssl/cert.pfx:/app/cert.pfx:ro
    networks:
      - bekleidung-network
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('https').get({hostname:'localhost',port:3077,path:'/api/health',rejectUnauthorized:false},(r)=>{process.exit(r.statusCode===200?0:1)})\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend - Nginx with SSL
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=https://${APP_HOST}:${BACKEND_PORT:-3077}/api
        - VITE_AZURE_CLIENT_ID=${AZURE_CLIENT_ID}
        - VITE_AZURE_TENANT_ID=${AZURE_TENANT_ID}
        - VITE_AZURE_REDIRECT_URI=https://${APP_HOST}:${FRONTEND_PORT:-3078}/auth/callback
    container_name: bekleidung-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3078}:443"
      - "8080:80"
    volumes:
      - ./ssl/cert.pem:/etc/nginx/ssl/cert.pem:ro
      - ./ssl/key.pem:/etc/nginx/ssl/key.pem:ro
      - ./frontend/nginx-ssl.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - bekleidung-network

networks:
  bekleidung-network:
    driver: bridge

volumes:
  data:
    driver: local
  uploads:
    driver: local
  backups:
    driver: local
  logs:
    driver: local
